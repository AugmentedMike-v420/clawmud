# ClawMud Test Agent with OpenClaw
# Attempt 6: Add git for github deps

FROM node:22-slim

# Install build dependencies (including git for github deps)
RUN apt-get update && apt-get install -y --no-install-recommends \
    netcat-openbsd \
    python3 \
    make \
    g++ \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm and setup global bin
RUN corepack enable && corepack prepare pnpm@latest --activate
ENV PNPM_HOME="/root/.local/share/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN mkdir -p $PNPM_HOME

WORKDIR /agent
RUN mkdir -p /agent/logs /agent/memory

# Set memory limit for node - 2GB should be enough
ENV NODE_OPTIONS="--max-old-space-size=2048"

# Install OpenClaw using pnpm
RUN pnpm add -g openclaw

# Verify installation
RUN openclaw --version || echo "openclaw installed"

# Copy config
COPY openclaw.yaml /agent/openclaw.yaml
COPY AGENTS.md /agent/AGENTS.md
COPY SOUL.md /agent/SOUL.md
COPY entrypoint.sh /agent/entrypoint.sh

RUN chmod +x /agent/entrypoint.sh

ENV MUD_HOST=host.docker.internal
ENV MUD_PORT=4000
ENV LOGS_DIR=/agent/logs

ENTRYPOINT ["/agent/entrypoint.sh"]
